<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="××™××•× ×™×">
    
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/180/dumbbell.png">

    <title>××¢×§×‘ ××™××•× ×™× - ×”×¨××œ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;500;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --bg-color: #09090b;
            --card-bg: rgba(30, 41, 59, 0.7);
            --border-color: rgba(255, 255, 255, 0.08);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --accent-blue: #38bdf8;
            --accent-orange: #f97316;
            --accent-green: #4ade80;
            --accent-red: #ef4444;
            --accent-purple: #a855f7;
            --input-bg: rgba(0,0,0,0.3);
        }

        [data-theme="light"] {
            --bg-color: #f1f5f9;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --accent-blue: #2563eb;
            --accent-orange: #ea580c;
            --accent-green: #16a34a;
            --accent-red: #dc2626;
            --accent-purple: #7e22ce;
            --input-bg: #f8fafc;
        }

        body {
            font-family: 'Heebo', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0; padding: 20px;
            padding-top: max(20px, env(safe-area-inset-top));
            min-height: 100vh;
            transition: background 0.3s, color 0.3s;
            -webkit-user-select: none;
        }

        .dashboard { max-width: 1100px; margin: 0 auto; }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .title-group h1 { margin: 0; font-weight: 800; font-size: 2rem; }
        .actions-group { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

        .icon-btn {
            background: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-muted);
            width: 40px; height: 40px; border-radius: 50%; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; justify-content: center; font-size: 1.1rem;
        }

        .weight-badge { 
            background: var(--card-bg); border: 1px solid var(--accent-blue); 
            padding: 5px 20px; border-radius: 50px; display: flex; align-items: center; gap: 10px; 
        }
        .weight-badge input { 
            background: transparent; border: none; color: var(--text-main); 
            font-weight: 800; font-size: 1.2rem; width: 60px; text-align: center; 
        }

        .goals-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-bottom: 25px; display: none; }
        .goal-card {
            background: linear-gradient(135deg, rgba(56, 189, 248, 0.05), rgba(168, 85, 247, 0.05));
            border: 1px solid var(--border-color); padding: 15px; border-radius: 16px; position: relative;
        }
        .progress-track { background: rgba(0,0,0,0.1); height: 8px; border-radius: 4px; overflow: hidden; margin-bottom: 5px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple)); width: 0%; transition: width 1s; }

        .glass-card {
            background: var(--card-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-color); border-radius: 20px; padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 25px;
        }
        h2 { font-size: 1.1rem; color: var(--text-muted); font-weight: 600; margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 20px; }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        @media (max-width: 768px) { .grid-2 { grid-template-columns: 1fr; } }

        table { width: 100%; border-collapse: separate; border-spacing: 0 12px; }
        
        .input-stylish {
            background: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-main);
            padding: 10px; border-radius: 8px; width: 100%; text-align: center;
            font-family: 'Heebo', sans-serif; font-size: 1rem;
        }

        .btn-action { background: var(--accent-blue); color: white; border: none; padding: 10px 0; border-radius: 8px; font-weight: 800; cursor: pointer; width: 100%; transition: 0.2s; }
        .rocket-btn {
            background: rgba(168, 85, 247, 0.1); border: 1px solid var(--accent-purple); color: var(--accent-purple);
            width: 35px; height: 35px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; align-items: center; justify-content: center; }
        .modal-content { background: var(--bg-color); padding: 30px; border-radius: 20px; border: 1px solid var(--accent-blue); max-width: 400px; width: 90%; text-align: center; }
    </style>
</head>
<body>

<div class="dashboard">
    <div class="header">
        <div class="title-group">
            <h1>××¢×§×‘ ××™××•× ×™×</h1>
        </div>

        <div class="actions-group">
            <div class="weight-badge">
                <span>××©×§×œ:</span>
                <input type="number" id="user-bw" value="63" onchange="logWeight()">
                <span>×§"×’</span>
            </div>
            
            <button class="icon-btn" onclick="toggleTheme()" id="theme-btn"><i class="fas fa-moon"></i></button>
            <button class="icon-btn" onclick="open1RM()"><i class="fas fa-calculator"></i></button>
            <button class="icon-btn" onclick="downloadBackup()"><i class="fas fa-download"></i></button>
            <button class="icon-btn" onclick="document.getElementById('import-file').click()"><i class="fas fa-upload"></i></button>
            <input type="file" id="import-file" style="display: none" onchange="importBackup(this)">
        </div>
    </div>

    <div id="goals-area" class="goals-container"></div>

    <div class="grid-2">
        <div class="glass-card">
            <h2 style="border-color: var(--accent-blue)">×¢×“×›×•×Ÿ ×›×•×—</h2>
            <table id="gym-inputs"></table>
            <div class="add-ex-row" style="display:flex; gap:10px; margin-top:15px; padding-top:15px; border-top:1px dashed var(--border-color);">
                <input type="text" id="new-ex-name" class="input-stylish" style="flex: 2; text-align: right;" placeholder="×©× ×ª×¨×’×™×œ...">
                <select id="new-ex-unit" class="input-stylish" style="flex: 1.5;">
                    <option value="weight">××©×§×œ (×§"×’)</option>
                    <option value="reps">×—×–×¨×•×ª</option>
                    <option value="time">×–××Ÿ</option>
                </select>
                <button class="btn-action" style="flex: 1; background: var(--accent-green);" onclick="addNewExerciseType()">×”×•×¡×£</button>
            </div>
        </div>

        <div class="glass-card">
            <h2 style="border-color: var(--accent-orange)">×¢×“×›×•×Ÿ ×¨×™×¦×”</h2>
            <table id="run-inputs"></table>
        </div>
    </div>

    <div class="glass-card">
        <h2>×©×™××™× ××™×©×™×™×</h2>
        <table style="width: 100%">
            <thead>
                <tr>
                    <th style="text-align: right; color: var(--text-muted)">×ª×¨×’×™×œ</th>
                    <th style="text-align: center; color: var(--text-muted)">×ª×•×¦××”</th>
                    <th style="text-align: center; color: var(--text-muted)">××“×“</th>
                    <th style="text-align: left; color: var(--text-muted)">×ª××¨×™×š</th>
                </tr>
            </thead>
            <tbody id="records-body"></tbody>
        </table>
    </div>

    <div class="glass-card">
        <h2>× ×™×ª×•×— ×’×¨×¤×™</h2>
        <select id="chart-select" class="input-stylish" style="width:100%; margin-bottom:20px;" onchange="renderChart()"></select>
        <div class="chart-container">
            <canvas id="mainChart"></canvas>
        </div>
    </div>

    <div class="glass-card">
        <h2 style="border-color: var(--accent-red)">×™×•××Ÿ ×¤×¢×™×œ×•×ª</h2>
        <table style="width: 100%">
            <tbody id="history-body"></tbody>
        </table>
    </div>
</div>

<div id="rm-modal" class="modal" onclick="if(event.target === this) this.style.display='none'">
    <div class="modal-content">
        <h2 style="border:none">××—×©×‘×•×Ÿ 1RM</h2>
        <p style="font-size: 0.9rem; color: var(--text-muted)">$$1RM = w \times (1 + \frac{r}{30})$$</p>
        <input type="number" id="calc-weight" class="input-stylish" placeholder="××©×§×œ (×§&quot;×’)" style="margin-bottom: 10px;">
        <input type="number" id="calc-reps" class="input-stylish" placeholder="×—×–×¨×•×ª" style="margin-bottom: 20px;">
        <div id="calc-result" style="font-size: 1.5rem; font-weight: bold; color: var(--accent-green); height: 30px;"></div>
        <button class="btn-action" onclick="calculate1RM()" style="margin-top: 20px;">×—×©×‘</button>
    </div>
</div>

<script>
    const DEFAULT_GYM_EXERCISES = [
        { name: "1RM ××ª×—", unit: "weight" },
        { name: "××ª×— ×œ×—×–×¨×•×ª (×œ×œ× ××©×§×œ)", unit: "reps" },
        { name: "1RM ××§×‘×™×œ×™×", unit: "weight" },
        { name: "××§×‘×™×œ×™× ××©×§×œ ×œ-5 ×—×–×¨×•×ª", unit: "weight" },
        { name: "××ª×— ×™×“ ××—×ª (×™××™×Ÿ)", unit: "reps" },
        { name: "××ª×— ×™×“ ××—×ª (×©×××œ)", unit: "reps" }
    ];
    const RUN_DISTANCES = [1, 5, 10, 15, 21, 42];
    
    const STORAGE_KEY = 'docs_tracker_v9_data';
    const EXERCISES_KEY = 'docs_tracker_v9_ex';
    const BW_KEY = 'docs_bw_val';
    const THEME_KEY = 'docs_theme_pref';
    const GOALS_KEY = 'docs_goals_list';

    let myChart = null;
    let gymExercisesList = [];
    let goalsList = [];

    window.onload = () => {
        loadTheme(); loadBW(); loadExercises(); loadGoals();
        renderInputs(); refreshAll(); initChartSelect();
        setTimeout(renderChart, 100);
    };

    function loadGoals() {
        const stored = localStorage.getItem(GOALS_KEY);
        goalsList = stored ? JSON.parse(stored) : [];
    }

    function addGoal(label, unit) {
        let targetRaw = prompt(`×”×›× ×¡ ×™×¢×“ ×¢×‘×•×¨ ${label}`);
        if(!targetRaw) return;
        let targetVal = (unit === 'time') ? parseTimeInput(targetRaw) : parseFloat(targetRaw);
        if(!targetVal || isNaN(targetVal)) return;
        goalsList = goalsList.filter(g => g.label !== label);
        goalsList.push({ label, target: targetVal, unit });
        localStorage.setItem(GOALS_KEY, JSON.stringify(goalsList));
        renderGoals();
    }

    function removeGoal(label) {
        goalsList = goalsList.filter(g => g.label !== label);
        localStorage.setItem(GOALS_KEY, JSON.stringify(goalsList));
        renderGoals();
    }

    function renderGoals() {
        const container = document.getElementById('goals-area');
        const history = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        if(goalsList.length === 0) { container.style.display = 'none'; return; }
        container.style.display = 'grid';
        container.innerHTML = goalsList.map(goal => {
            const data = history.filter(h => h.label === goal.label);
            let currentBest = 0;
            if(data.length > 0) {
                const bestEntry = data.reduce((a, b) => (goal.unit === 'time' && goal.label.includes('×¨×™×¦×”')) ? (a.val < b.val ? a : b) : (a.val > b.val ? a : b));
                currentBest = bestEntry.val;
            }
            let percent = currentBest > 0 ? Math.min(100, Math.round((currentBest / goal.target) * 100)) : 0;
            return `
            <div class="goal-card">
                <button class="btn-del-goal" onclick="removeGoal('${goal.label}')">âœ•</button>
                <div class="goal-header"><span>${goal.label}</span><span style="color: var(--accent-purple)">${percent}%</span></div>
                <div class="progress-track"><div class="progress-fill" style="width: ${percent}%"></div></div>
                <div class="goal-stats"><span>×©×™×: ${formatValue(currentBest, goal.unit)}</span><span>×™×¢×“: ${formatValue(goal.target, goal.unit)}</span></div>
            </div>`;
        }).join('');
    }

    function renderInputs() {
        document.getElementById('gym-inputs').innerHTML = gymExercisesList.map((ex, i) => `
            <tr>
                <td style="width:35%;">${ex.name}</td>
                <td style="width:10%;"><button class="rocket-btn" onclick="addGoal('${ex.name}', '${ex.unit}')">ğŸš€</button></td>
                <td style="width:30%;"><input type="${ex.unit === 'time' ? 'text' : 'number'}" class="input-stylish" id="gym-in-${i}" placeholder="${ex.unit === 'time' ? 'MM:SS' : '×§&quot;×’'}"></td>
                <td style="width:15%;"><button class="btn-action" onclick="addGym(${i})">×¢×“×›×Ÿ</button></td>
                <td style="width:10%;"><button class="btn-remove-row" onclick="removeExerciseRow(${i})">âœ•</button></td>
            </tr>`).join('');

        document.getElementById('run-inputs').innerHTML = RUN_DISTANCES.map((d, i) => `
            <tr>
                <td style="width:45%;">${d} ×§"×</td>
                <td style="width:30%;"><input type="text" class="input-stylish" id="run-in-${i}" placeholder="HH:MM:SS"></td>
                <td style="width:15%;"><button class="btn-action" style="background:var(--accent-orange)" onclick="addRun(${i}, ${d})">×¢×“×›×Ÿ</button></td>
                <td style="width:10%;"></td> 
            </tr>`).join('');
    }

    function loadExercises() {
        const stored = localStorage.getItem(EXERCISES_KEY);
        gymExercisesList = stored ? JSON.parse(stored) : [...DEFAULT_GYM_EXERCISES];
    }
    function refreshAll() { renderRecords(); renderHistory(); renderChart(); renderGoals(); }
    
    function addGym(idx) {
        const ex = gymExercisesList[idx]; const inputEl = document.getElementById(`gym-in-${idx}`);
        let val = (ex.unit === 'time') ? parseTimeInput(inputEl.value) : parseFloat(inputEl.value);
        if(!val) return;
        saveData('gym', ex.name, val, null, ex.unit); inputEl.value = '';
    }
    function addRun(idx, dist) {
        const inputEl = document.getElementById(`run-in-${idx}`); const val = parseTimeInput(inputEl.value);
        if (!val) return;
        saveData('run', `×¨×™×¦×” ${dist} ×§"×`, val, dist, 'time'); inputEl.value = '';
    }
    function saveData(type, label, val, dist, unit) {
        const history = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        history.push({ id: Date.now(), date: new Date().toLocaleDateString('he-IL'), timestamp: Date.now(), type, label, val, dist, unit });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(history)); refreshAll();
    }
    function addNewExerciseType() {
        const name = document.getElementById('new-ex-name').value.trim(); const unit = document.getElementById('new-ex-unit').value;
        if (!name || gymExercisesList.some(e => e.name === name)) return;
        gymExercisesList.push({ name, unit }); localStorage.setItem(EXERCISES_KEY, JSON.stringify(gymExercisesList));
        document.getElementById('new-ex-name').value = ''; renderInputs(); initChartSelect(); refreshAll();
    }
    function removeExerciseRow(index) {
        if(!confirm("×œ×”×¡×™×¨?")) return; gymExercisesList.splice(index, 1);
        localStorage.setItem(EXERCISES_KEY, JSON.stringify(gymExercisesList)); renderInputs(); initChartSelect(); refreshAll();
    }
    
    function parseTimeInput(str) {
        if(!str) return 0; const p = str.toString().split(':').map(Number);
        if (p.length === 1) return p[0] * 60; if (p.length === 2) return p[0] * 60 + p[1];
        if (p.length === 3) return p[0] * 3600 + p[1] * 60 + p[2];
        return 0;
    }
    function formatTime(s) {
        const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = Math.floor(s%60);
        return h>0 ? `${h}:${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}` : `${m}:${sec.toString().padStart(2,'0')}`;
    }
    function formatValue(val, unit) {
        if (unit === 'time') return formatTime(val);
        return val + (unit === 'weight' ? ' ×§"×’' : ' ×—×–\'');
    }
    function loadBW() { const bw = localStorage.getItem(BW_KEY); if(bw) document.getElementById('user-bw').value = bw; }
    function logWeight() {
        const bw = parseFloat(document.getElementById('user-bw').value); if(!bw) return;
        localStorage.setItem(BW_KEY, bw); saveData('bw', '××¢×§×‘ ××©×§×œ ×’×•×£', bw, null, 'weight');
    }

    function downloadBackup() {
        const data = { history: localStorage.getItem(STORAGE_KEY), exercises: localStorage.getItem(EXERCISES_KEY), bw: localStorage.getItem(BW_KEY), goals: localStorage.getItem(GOALS_KEY) };
        const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `backup.json`; a.click();
    }
    function importBackup(input) {
        const file = input.files[0]; if(!file) return; const reader = new FileReader();
        reader.onload = function(e) {
            const data = JSON.parse(e.target.result);
            localStorage.setItem(STORAGE_KEY, data.history); localStorage.setItem(EXERCISES_KEY, data.exercises);
            localStorage.setItem(BW_KEY, data.bw); localStorage.setItem(GOALS_KEY, data.goals); location.reload();
        }; reader.readAsText(file);
    }

    function toggleTheme() {
        const t = document.documentElement.getAttribute('data-theme') === 'light' ? 'default' : 'light';
        document.documentElement.setAttribute('data-theme', t); localStorage.setItem(THEME_KEY, t);
        document.getElementById('theme-btn').innerHTML = t === 'light' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>'; renderChart();
    }
    function loadTheme() {
        const saved = localStorage.getItem(THEME_KEY) || 'default'; document.documentElement.setAttribute('data-theme', saved);
        document.getElementById('theme-btn').innerHTML = saved === 'light' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
    }
    function initChartSelect() {
        const sel = document.getElementById('chart-select');
        let opts = `<option value="××¢×§×‘ ××©×§×œ ×’×•×£" data-unit="weight">ğŸ“‰ ××©×§×œ ×’×•×£</option>`;
        opts += gymExercisesList.map(e => `<option value="${e.name}" data-unit="${e.unit}">${e.name}</option>`).join('');
        opts += RUN_DISTANCES.map(d => `<option value="×¨×™×¦×” ${d} ×§&quot;×" data-unit="time">×¨×™×¦×” ${d} ×§"×</option>`).join('');
        sel.innerHTML = opts;
    }
    function renderChart() {
        const sel = document.getElementById('chart-select'); if (!sel || sel.selectedIndex === -1) return;
        const label = sel.value; const unit = sel.options[sel.selectedIndex].getAttribute('data-unit');
        const history = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        const dataPoints = history.filter(h => h.label === label).sort((a,b) => a.timestamp - b.timestamp);
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'line',
            data: { labels: dataPoints.map(p => p.date), datasets: [{ label: label, data: dataPoints.map(p => p.val), borderColor: '#38bdf8', tension: 0.4, fill: true }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { callback: (val) => unit === 'time' ? formatTime(val) : val } } } }
        });
    }

    function open1RM() { document.getElementById('rm-modal').style.display = 'flex'; }
    function calculate1RM() {
        const w = parseFloat(document.getElementById('calc-weight').value); const r = parseFloat(document.getElementById('calc-reps').value);
        if(w && r) document.getElementById('calc-result').innerText = Math.round(w * (1 + r/30)) + ' ×§"×’';
    }
    
    function renderRecords() {
        const history = JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; const bw = parseFloat(document.getElementById('user-bw').value) || 1;
        let html = '';
        gymExercisesList.forEach(ex => {
            const data = history.filter(h => h.label === ex.name); if(data.length === 0) return;
            const best = data.reduce((a, b) => a.val > b.val ? a : b);
            let stats = ex.unit === 'weight' ? `<span class="tag tag-blue">${Math.round((best.val / bw) * 100)}% BW</span>` : '-';
            html += `<tr><td style="text-align:right">${ex.name}</td><td style="text-align:center" class="val-big">${formatValue(best.val, ex.unit)}</td><td style="text-align:center">${stats}</td><td style="text-align:left; font-size:0.8rem">${best.date}</td></tr>`;
        });
        RUN_DISTANCES.forEach(d => {
            const label = `×¨×™×¦×” ${d} ×§"×`; const data = history.filter(h => h.label === label); if(data.length === 0) return;
            const best = data.reduce((a, b) => a.val < b.val ? a : b); 
            html += `<tr><td style="text-align:right">${label}</td><td style="text-align:center" class="val-big">${formatTime(best.val)}</td><td style="text-align:center"><span class="tag tag-orange">×§×¦×‘: ${formatTime(best.val / d)}</span></td><td style="text-align:left; font-size:0.8rem">${best.date}</td></tr>`;
        });
        document.getElementById('records-body').innerHTML = html || '<tr><td colspan="4" style="text-align:center">××™×Ÿ × ×ª×•× ×™×</td></tr>';
    }

    function renderHistory() {
        const history = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        document.getElementById('history-body').innerHTML = history.sort((a,b) => b.timestamp - a.timestamp).map(item => `
            <tr><td style="text-align:right; color:var(--text-muted)">${item.date}</td><td style="text-align:right">${item.label}</td><td style="text-align:center" class="val-big">${formatValue(item.val, item.unit)}</td><td style="text-align:left"><button class="btn-del-log" onclick="deleteEntry(${item.id})">××—×§</button></td></tr>`).join('');
    }
    function deleteEntry(id) {
        let h = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        localStorage.setItem(STORAGE_KEY, JSON.stringify(h.filter(i => i.id !== id))); refreshAll();
    }
</script>
</body>
</html>
