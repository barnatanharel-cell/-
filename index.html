<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>××¢×§×‘ ××™××•× ×™× - ×”×¨××œ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;500;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --bg-color: #09090b;
            --card-bg: rgba(30, 41, 59, 0.7);
            --border-color: rgba(255, 255, 255, 0.08);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --accent-blue: #38bdf8;
            --accent-orange: #f97316;
            --accent-green: #4ade80;
            --accent-red: #ef4444;
            --accent-purple: #a855f7;
            --input-bg: rgba(0,0,0,0.3);
        }

        [data-theme="light"] {
            --bg-color: #f1f5f9;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --accent-blue: #2563eb;
            --accent-orange: #ea580c;
            --accent-green: #16a34a;
            --accent-red: #dc2626;
            --accent-purple: #7e22ce;
            --input-bg: #f8fafc;
        }

        body {
            font-family: 'Heebo', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0; padding: 20px;
            min-height: 100vh;
            transition: background 0.3s, color 0.3s;
        }

        .dashboard { max-width: 1100px; margin: 0 auto; }

        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .title-group h1 { margin: 0; font-weight: 800; font-size: 2rem; }
        .actions-group { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

        .icon-btn {
            background: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-muted);
            width: 40px; height: 40px; border-radius: 50%; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; justify-content: center; font-size: 1.1rem;
        }
        .icon-btn:hover { color: var(--text-main); border-color: var(--accent-blue); transform: scale(1.1); }

        .weight-badge { 
            background: var(--card-bg); border: 1px solid var(--accent-blue); 
            padding: 5px 20px; border-radius: 50px; display: flex; align-items: center; gap: 10px; 
        }
        .weight-badge input { 
            background: transparent; border: none; color: var(--text-main); 
            font-weight: 800; font-size: 1.2rem; width: 60px; text-align: center; 
            border-bottom: 2px solid var(--accent-blue); 
        }

        /* Goals / Progress Bars */
        .goals-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-bottom: 25px; display: none; }
        .goal-card {
            background: linear-gradient(135deg, rgba(56, 189, 248, 0.05), rgba(168, 85, 247, 0.05));
            border: 1px solid var(--border-color); padding: 15px; border-radius: 16px; position: relative;
        }
        .goal-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; }
        .progress-track { background: rgba(0,0,0,0.1); height: 8px; border-radius: 4px; overflow: hidden; margin-bottom: 5px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple)); width: 0%; transition: width 1s; }
        .goal-stats { font-size: 0.8rem; color: var(--text-muted); display: flex; justify-content: space-between; }
        .btn-del-goal { position: absolute; top: 10px; left: 10px; background: transparent; border: none; color: var(--accent-red); cursor: pointer; opacity: 0.6; }
        .btn-del-goal:hover { opacity: 1; }

        /* Cards & Grid */
        .glass-card {
            background: var(--card-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-color); border-radius: 20px; padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 25px;
        }
        h2 { font-size: 1.1rem; color: var(--text-muted); font-weight: 600; margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 20px; }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        @media (max-width: 768px) { .grid-2 { grid-template-columns: 1fr; } }

        table { width: 100%; border-collapse: separate; border-spacing: 0 12px; }
        td { vertical-align: middle; }
        
        .input-stylish {
            background: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-main);
            padding: 10px; border-radius: 8px; width: 100%; text-align: center;
            font-family: 'Heebo', sans-serif; font-size: 1rem;
        }
        .input-stylish:focus { outline: none; border-color: var(--accent-blue); }

        /* Buttons */
        .btn-action { background: var(--accent-blue); color: white; border: none; padding: 10px 0; border-radius: 8px; font-weight: 800; cursor: pointer; width: 100%; transition: 0.2s; }
        .btn-action:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-run { background: var(--accent-orange); }
        .btn-add { background: var(--accent-green); }
        
        .rocket-btn {
            background: rgba(168, 85, 247, 0.1); border: 1px solid var(--accent-purple); color: var(--accent-purple);
            width: 35px; height: 35px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .rocket-btn:hover { background: var(--accent-purple); color: white; }

        .btn-remove-row {
            background: transparent; border: 1px solid var(--accent-red); color: var(--accent-red);
            width: 30px; height: 30px; border-radius: 8px; cursor: pointer; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-remove-row:hover { background: var(--accent-red); color: white; }
        .btn-del-log { background: transparent; border: 1px solid var(--accent-red); color: var(--accent-red); padding: 5px 10px; font-size: 0.8rem; border-radius: 6px; cursor: pointer; }
        .btn-del-log:hover { background: var(--accent-red); color: white; }

        .add-ex-row { display: flex; gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 1px dashed var(--border-color); align-items: center; }
        select.input-stylish { cursor: pointer; text-align-last: center; }

        .val-big { font-size: 1.1rem; font-weight: 800; color: var(--text-main); }
        .tag { font-size: 0.75rem; padding: 3px 8px; border-radius: 4px; font-weight: 500; display: inline-block; }
        .tag-blue { background: rgba(56, 189, 248, 0.1); color: var(--accent-blue); border: 1px solid var(--accent-blue); }
        .tag-orange { background: rgba(249, 115, 22, 0.1); color: var(--accent-orange); border: 1px solid var(--accent-orange); }

        select.chart-sel { width: 100%; margin-bottom: 20px; background: var(--input-bg); }
        .chart-container { height: 350px; position: relative; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; align-items: center; justify-content: center; }
        .modal-content { background: var(--bg-color); padding: 30px; border-radius: 20px; border: 1px solid var(--accent-blue); max-width: 400px; width: 90%; text-align: center; }
    </style>
</head>
<body>

<div class="dashboard">
    <div class="header">
        <div class="title-group">
            <h1>××¢×§×‘ ××™××•× ×™×</h1>
        </div>

        <div class="actions-group">
            <div class="weight-badge">
                <span>××©×§×œ:</span>
                <input type="number" id="user-bw" value="63" onchange="logWeight()">
                <span>×§"×’</span>
            </div>
            
            <button class="icon-btn" onclick="toggleTheme()" id="theme-btn" title="×©× ×” ×¢×¨×›×ª × ×•×©×"><i class="fas fa-moon"></i></button>
            <button class="icon-btn" onclick="open1RM()" title="××—×©×‘×•×Ÿ 1RM"><i class="fas fa-calculator"></i></button>
            <button class="icon-btn" onclick="downloadBackup()" title="×”×•×¨×“ ×’×™×‘×•×™"><i class="fas fa-download"></i></button>
            <button class="icon-btn" onclick="document.getElementById('import-file').click()" title="×˜×¢×Ÿ ×’×™×‘×•×™"><i class="fas fa-upload"></i></button>
            <input type="file" id="import-file" style="display: none" onchange="importBackup(this)">
        </div>
    </div>

    <div id="goals-area" class="goals-container"></div>

    <div class="grid-2">
        <div class="glass-card">
            <h2 style="border-color: var(--accent-blue)">×¢×“×›×•×Ÿ ×›×•×—</h2>
            <table id="gym-inputs"></table>
            <div class="add-ex-row">
                <input type="text" id="new-ex-name" class="input-stylish" style="flex: 2; text-align: right;" placeholder="×©× ×ª×¨×’×™×œ...">
                <select id="new-ex-unit" class="input-stylish" style="flex: 1.5;">
                    <option value="weight">××©×§×œ (×§"×’)</option>
                    <option value="reps">×—×–×¨×•×ª</option>
                    <option value="time">×–××Ÿ</option>
                </select>
                <button class="btn-action btn-add" style="flex: 1;" onclick="addNewExerciseType()">×”×•×¡×£</button>
            </div>
        </div>

        <div class="glass-card">
            <h2 style="border-color: var(--accent-orange)">×¢×“×›×•×Ÿ ×¨×™×¦×”</h2>
            <table id="run-inputs"></table>
        </div>
    </div>

    <div class="glass-card">
        <h2>×©×™××™× ××™×©×™×™×</h2>
        <table style="width: 100%">
            <thead>
                <tr>
                    <th style="text-align: right; color: var(--text-muted)">×ª×¨×’×™×œ</th>
                    <th style="text-align: center; color: var(--text-muted)">×ª×•×¦××”</th>
                    <th style="text-align: center; color: var(--text-muted)">××“×“</th>
                    <th style="text-align: left; color: var(--text-muted)">×ª××¨×™×š</th>
                </tr>
            </thead>
            <tbody id="records-body"></tbody>
        </table>
    </div>

    <div class="glass-card">
        <h2>× ×™×ª×•×— ×’×¨×¤×™</h2>
        <select id="chart-select" class="input-stylish chart-sel" onchange="renderChart()"></select>
        <div class="chart-container">
            <canvas id="mainChart"></canvas>
        </div>
    </div>

    <div class="glass-card">
        <h2 style="border-color: var(--accent-red)">×™×•××Ÿ ×¤×¢×™×œ×•×ª</h2>
        <table style="width: 100%">
            <tbody id="history-body"></tbody>
        </table>
    </div>
</div>

<div id="rm-modal" class="modal" onclick="if(event.target === this) this.style.display='none'">
    <div class="modal-content">
        <h2 style="border:none">××—×©×‘×•×Ÿ 1RM</h2>
        <input type="number" id="calc-weight" class="input-stylish" placeholder="××©×§×œ (×§&quot;×’)" style="margin-bottom: 10px;">
        <input type="number" id="calc-reps" class="input-stylish" placeholder="×—×–×¨×•×ª" style="margin-bottom: 20px;">
        <div id="calc-result" style="font-size: 1.5rem; font-weight: bold; color: var(--accent-green); height: 30px;"></div>
        <button class="btn-action" onclick="calculate1RM()" style="margin-top: 20px;">×—×©×‘</button>
    </div>
</div>

<script>
    const DEFAULT_GYM_EXERCISES = [
        { name: "1RM ××ª×—", unit: "weight" },
        { name: "××ª×— ×œ×—×–×¨×•×ª (×œ×œ× ××©×§×œ)", unit: "reps" },
        { name: "1RM ××§×‘×™×œ×™×", unit: "weight" },
        { name: "××§×‘×™×œ×™× ××©×§×œ ×œ-5 ×—×–×¨×•×ª", unit: "weight" },
        { name: "××ª×— ×™×“ ××—×ª (×™××™×Ÿ)", unit: "reps" },
        { name: "××ª×— ×™×“ ××—×ª (×©×××œ)", unit: "reps" }
    ];
    const RUN_DISTANCES = [1, 5, 10, 15, 21, 42];
    
    const STORAGE_KEY = 'docs_tracker_v9_data';
    const EXERCISES_KEY = 'docs_tracker_v9_ex';
    const BW_KEY = 'docs_bw_val';
    const THEME_KEY = 'docs_theme_pref';
    const GOALS_KEY = 'docs_goals_list';

    let myChart = null;
    let gymExercisesList = [];
    let goalsList = [];

    window.onload = () => {
        loadTheme();
        loadBW();
        loadExercises();
        loadGoals();
        renderInputs();
        refreshAll();
        initChartSelect();
        setTimeout(renderChart, 100);
    };

    // --- Goals Logic ---
    function loadGoals() {
        const stored = localStorage.getItem(GOALS_KEY);
        goalsList = stored ? JSON.parse(stored) : [];
    }

    function addGoal(label, unit) {
        let promptText = `×”×›× ×¡ ×™×¢×“ ×¢×‘×•×¨ ${label}`;
        if(unit === 'weight') promptText += ' (×‘×§"×’):';
        else if(unit === 'reps') promptText += ' (×—×–×¨×•×ª):';
        else promptText += ' (×–××Ÿ - MM:SS):';

        let targetRaw = prompt(promptText);
        if(!targetRaw) return;

        let targetVal;
        if(unit === 'time') targetVal = parseTimeInput(targetRaw);
        else targetVal = parseFloat(targetRaw);

        if(!targetVal || isNaN(targetVal)) { alert("×¢×¨×š ×œ× ×ª×§×™×Ÿ"); return; }

        if(goalsList.some(g => g.label === label)) {
            if(!confirm("×›×‘×¨ ×§×™×™× ×™×¢×“. ×œ×”×—×œ×™×£ ××•×ª×•?")) return;
            goalsList = goalsList.filter(g => g.label !== label);
        }

        goalsList.push({ label, target: targetVal, unit });
        localStorage.setItem(GOALS_KEY, JSON.stringify(goalsList));
        renderGoals();
    }

    function removeGoal(label) {
        if(!confirm("×œ××—×•×§ ××ª ×”×™×¢×“?")) return;
        goalsList = goalsList.filter(g => g.label !== label);
        localStorage.setItem(GOALS_KEY, JSON.stringify(goalsList));
        renderGoals();
    }

    function renderGoals() {
        const container = document.getElementById('goals-area');
        const history = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        
        if(goalsList.length === 0) {
            container.style.display = 'none';
            return;
        }
        container.style.display = 'grid';

        container.innerHTML = goalsList.map(goal => {
            const data = history.filter(h => h.label === goal.label);
            let currentBest = 0;
            
            if(data.length > 0) {
                const bestEntry = data.reduce((a, b) => {
                    if (goal.unit === 'time' && goal.label.includes('×¨×™×¦×”')) return a.val < b.val ? a : b;
                    return a.val > b.val ? a : b;
                });
                currentBest = bestEntry.val;
            }

            let percent = 0;
            if(currentBest > 0) {
                if (!(goal.unit === 'time' && goal.label.includes('×¨×™×¦×”'))) {
                    percent = Math.min(100, Math.round((currentBest / goal.target) * 100));
                }
            }

            const displayTarget = formatValue(goal.target, goal.unit);
            const displayCurrent = formatValue(currentBest, goal.unit);

            return `
            <div class="goal-card">
                <button class="btn-del-goal" onclick="removeGoal('${goal.label}')">âœ•</button>
                <div class="goal-header">
                    <span>${goal.label}</span>
                    <span style="color: var(--accent-purple)">${percent}%</span>
                </div>
                <div class="progress-track">
                    <div class="progress-fill" style="width: ${percent}%"></div>
                </div>
                <div class="goal-stats">
                    <span>×©×™×: ${displayCurrent}</span>
                    <span>×™×¢×“: ${displayTarget}</span>
                </div>
            </div>`;
        }).join('');
    }

    // --- Inputs Render (Fixed Placeholder) ---
    function renderInputs() {
        document.getElementById('gym-inputs').innerHTML = gymExercisesList.map((ex, i) => {
            // ×”×ª×™×§×•×Ÿ ×›××Ÿ: ×©×™××•×© ×‘ &quot; ×›×“×™ ×œ× ×œ×©×‘×•×¨ ××ª ×”-HTML
            let placeholder = ex.unit === 'time' ? 'MM:SS' : (ex.unit === 'weight' ? '×§&quot;×’' : '×—×–×¨×•×ª');
            let inputType = ex.unit === 'time' ? 'text' : 'number';
            return `
            <tr>
                <td style="width:35%; padding-left:10px;">${ex.name}</td>
                <td style="width:10%;">
                    <button class="rocket-btn" onclick="addGoal('${ex.name}', '${ex.unit}')" title="×”×’×“×¨ ×™×¢×“">ğŸš€</button>
                </td>
                <td style="width:30%; padding:0 5px;"><input type="${inputType}" class="input-stylish" id="gym-in-${i}" placeholder="${placeholder}"></td>
                <td style="width:15%; padding-left:5px;"><button class="btn-action" onclick="addGym(${i})">×¢×“×›×Ÿ</button></td>
                <td style="width:10%;"><button class="btn-remove-row" onclick="removeExerciseRow(${i})">âœ•</button></td>
            </tr>`;
        }).join('');

        document.getElementById('run-inputs').innerHTML = RUN_DISTANCES.map((d, i) => `
            <tr>
                <td style="width:35%; padding-left:10px;">${d} ×§"×</td>
                <td style="width:10%;"></td>
                <td style="width:30%; padding:0 5px;"><input type="text" class="input-stylish" id="run-in-${i}" placeholder="HH:MM:SS"></td>
                <td style="width:15%; padding-left:5px;"><button class="btn-action btn-run" onclick="addRun(${i}, ${d})">×¢×“×›×Ÿ</button></td>
                <td style="width:10%;"></td> 
            </tr>`).join('');
    }

    // --- Standard Logic ---
    function loadExercises() {
        const stored = localStorage.getItem(EXERCISES_KEY);
        gymExercisesList = stored ? JSON.parse(stored) : [...DEFAULT_GYM_EXERCISES];
        if(!stored) localStorage.setItem(EXERCISES_KEY, JSON.stringify(gymExercisesList));
    }
    function refreshAll() { renderRecords(); renderHistory(); renderChart(); renderGoals(); }
    
    function addGym(idx) {
        const ex = gymExercisesList[idx];
        const inputEl = document.getElementById(`gym-in-${idx}`);
        let rawVal = inputEl.value;
        if (!rawVal) return;
        let val = (ex.unit === 'time') ? parseTimeInput(rawVal) : parseFloat(rawVal);
        if(isNaN(val) || val === 0) return;
        saveData('gym', ex.name, val, null, ex.unit);
        inputEl.value = '';
    }
    function addRun(idx, dist) {
        const inputEl = document.getElementById(`run-in-${idx}`);
        const val = parseTimeInput(inputEl.value);
        if (!val) return;
        saveData('run', `×¨×™×¦×” ${dist} ×§"×`, val, dist, 'time');
        inputEl.value = '';
    }
    function saveData(type, label, val, dist, unit) {
        const history = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        history.push({ id: Date.now(), date: new Date().toLocaleDateString('he-IL'), timestamp: Date.now(), type, label, val, dist, unit });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
        refreshAll();
    }
    function addNewExerciseType() {
        const name = document.getElementById('new-ex-name').value.trim();
        const unit = document.getElementById('new-ex-unit').value;
        if (!name || gymExercisesList.some(e => e.name === name)) return;
        gymExercisesList.push({ name, unit });
        localStorage.setItem(EXERCISES_KEY, JSON.stringify(gymExercisesList));
        document.getElementById('new-ex-name').value = '';
        renderInputs();
        initChartSelect();
        refreshAll();
    }
    function removeExerciseRow(index) {
        if(!confirm("×œ×”×¡×™×¨ ××ª ×”×ª×¨×’×™×œ?")) return;
        gymExercisesList.splice(index, 1);
        localStorage.setItem(EXERCISES_KEY, JSON.stringify(gymExercisesList));
        renderInputs();
        initChartSelect();
        refreshAll();
    }
    
    // --- Helpers ---
    function parseTimeInput(str) {
        if(!str) return 0;
        const parts = str.toString().split(':').map(Number);
        if (parts.length === 1) return parts[0] * 60; 
        if (parts.length === 2) return parts[0] * 60 + parts[1];
        if (parts.length === 3) return parts[0] * 3600 + parts[1] * 60 + parts[2];
        return 0;
    }
    function formatTime(s) {
        const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = Math.floor(s%60);
        const pad = n => n.toString().padStart(2,'0');
        return h>0 ? `${h}:${pad(m)}:${pad(sec)}` : `${m}:${pad(sec)}`;
    }
    function formatValue(val, unit) {
        if (unit === 'time') return formatTime(val);
        if (unit === 'weight') return val + ' ×§"×’';
        if (unit === 'reps') return val + ' ×—×–\'';
        return val;
    }
    function loadBW() {
        const bw = localStorage.getItem(BW_KEY);
        if(bw) document.getElementById('user-bw').value = bw;
    }
    function logWeight() {
        const bw = parseFloat(document.getElementById('user-bw').value);
        if(!bw) return;
        localStorage.setItem(BW_KEY, bw);
        saveData('bw', '××¢×§×‘ ××©×§×œ ×’×•×£', bw, null, 'weight');
    }

    // --- Backup & Theme ---
    function downloadBackup() {
        const data = { history: localStorage.getItem(STORAGE_KEY), exercises: localStorage.getItem(EXERCISES_KEY), bw: localStorage.getItem(BW_KEY), goals: localStorage.getItem(GOALS_KEY) };
        const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `backup.json`;
        a.click();
    }
    function importBackup(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if(data.history) localStorage.setItem(STORAGE_KEY, data.history);
                if(data.exercises) localStorage.setItem(EXERCISES_KEY, data.exercises);
                if(data.bw) localStorage.setItem(BW_KEY, data.bw);
                if(data.goals) localStorage.setItem(GOALS_KEY, data.goals);
                location.reload();
            } catch(err) { alert("×©×’×™××”"); }
        };
        reader.readAsText(file);
    }

    function toggleTheme() {
        const current = document.documentElement.getAttribute('data-theme') === 'light' ? 'default' : 'light';
        document.documentElement.setAttribute('data-theme', current);
        localStorage.setItem(THEME_KEY, current);
        document.getElementById('theme-btn').innerHTML = current === 'light' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        renderChart();
    }
    function loadTheme() {
        const saved = localStorage.getItem(THEME_KEY) || 'default';
        document.documentElement.setAttribute('data-theme', saved);
        document.getElementById('theme-btn').innerHTML = saved === 'light' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
    }
    function initChartSelect() {
        const sel = document.getElementById('chart-select');
        const curr = sel.value;
        let opts = `<option value="××¢×§×‘ ××©×§×œ ×’×•×£" data-unit="weight">ğŸ“‰ ××¢×§×‘ ××©×§×œ ×’×•×£</option>`;
        opts += gymExercisesList.map(e => `<option value="${e.name}" data-unit="${e.unit}">${e.name}</option>`).join('');
        opts += RUN_DISTANCES.map(d => `<option value="×¨×™×¦×” ${d} ×§&quot;×" data-unit="time">×¨×™×¦×” ${d} ×§"×</option>`).join('');
        sel.innerHTML = opts;
        if(curr) sel.value = curr;
    }
    function renderChart() {
        const sel = document.getElementById('chart-select');
        if (!sel || sel.selectedIndex === -1) return;
        const label = sel.value;
        const unit = sel.options[sel.selectedIndex].getAttribute('data-unit');
        const history = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        const dataPoints = history.filter(h => h.label === label).sort((a,b) => a.timestamp - b.timestamp);
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(myChart) myChart.destroy();
        let lineColor = '#38bdf8'; 
        if (label.includes('×¨×™×¦×”')) lineColor = '#f97316';
        if (label.includes('××©×§×œ ×’×•×£')) lineColor = '#4ade80';
        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dataPoints.map(p => p.date),
                datasets: [{
                    label: label,
                    data: dataPoints.map(p => p.val),
                    borderColor: lineColor,
                    backgroundColor: 'rgba(255,255,255,0.05)',
                    borderWidth: 3,
                    pointRadius: 6,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: { callbacks: { label: (ctx) => formatValue(ctx.raw, unit) } } },
                scales: {
                    y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8', callback: (val) => unit === 'time' ? formatTime(val) : val } },
                    x: { ticks: { color: '#94a3b8' }, grid: { display: false } }
                }
            }
        });
    }

    // --- Extras ---
    function open1RM() { document.getElementById('rm-modal').style.display = 'flex'; }
    function calculate1RM() {
        const w = parseFloat(document.getElementById('calc-weight').value);
        const r = parseFloat(document.getElementById('calc-reps').value);
        if(w && r) document.getElementById('calc-result').innerText = Math.round(w * (1 + r/30)) + ' ×§"×’';
    }
    
    // Records & History
    function renderRecords() {
        const history = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        const bw = parseFloat(document.getElementById('user-bw').value) || 1;
        const tbody = document.getElementById('records-body');
        let html = '';
        gymExercisesList.forEach(ex => {
            const data = history.filter(h => h.label === ex.name);
            if(data.length === 0) return;
            const best = data.reduce((a, b) => a.val > b.val ? a : b);
            let stats = '-';
            if(ex.unit === 'weight' && ex.name.includes('1RM')) {
                const ratio = Math.round((best.val / bw) * 100);
                stats = `<span class="tag tag-blue">${ratio}% BW</span>`;
            }
            html += `<tr><td style="text-align:right">${ex.name}</td><td style="text-align:center" class="val-big">${formatValue(best.val, ex.unit)}</td><td style="text-align:center">${stats}</td><td style="text-align:left; color:var(--text-muted); font-size:0.8rem">${best.date}</td></tr>`;
        });
        RUN_DISTANCES.forEach(d => {
            const label = `×¨×™×¦×” ${d} ×§"×`;
            const data = history.filter(h => h.label === label);
            if(data.length === 0) return;
            const best = data.reduce((a, b) => a.val < b.val ? a : b); 
            const paceStr = formatTime(best.val / d);
            html += `<tr><td style="text-align:right">${label}</td><td style="text-align:center" class="val-big" style="color:var(--accent-orange)">${formatTime(best.val)}</td><td style="text-align:center"><span class="tag tag-orange">×§×¦×‘: ${paceStr}</span></td><td style="text-align:left; color:var(--text-muted); font-size:0.8rem">${best.date}</td></tr>`;
        });
        tbody.innerHTML = html || '<tr><td colspan="4" style="text-align:center; padding: 20px">××™×Ÿ × ×ª×•× ×™× ×¢×“×™×™×Ÿ</td></tr>';
    }

    function renderHistory() {
        const history = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        const sorted = history.sort((a,b) => b.timestamp - a.timestamp);
        document.getElementById('history-body').innerHTML = sorted.map(item => `
            <tr><td style="text-align:right; font-size:0.85rem; color:var(--text-muted)">${item.date}</td><td style="text-align:right">${item.label}</td><td style="text-align:center" class="val-big" style="font-size:1rem">${formatValue(item.val, item.unit)}</td><td style="text-align:left"><button class="btn-del-log" onclick="deleteEntry(${item.id})">××—×§</button></td></tr>`).join('');
    }
    function deleteEntry(id) {
        if(!confirm("×œ××—×•×§?")) return;
        let history = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        history = history.filter(item => item.id !== id);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
        refreshAll();
    }
</script>
</body>
</html>
